\documentclass{article}
\usepackage[UTF8]{ctex}  %加载包，因为我们在用中文写文档，所以必须加载这个包，否则不支持中文
\usepackage{multicol}  %加载包
\usepackage[top=1in, bottom=1in, left=1.25in, right=1.25in]{geometry}  %加载包
\usepackage{lscape}
\usepackage[colorlinks,linkcolor=blue]{hyperref}
\usepackage{amsmath}
\usepackage{tikz,tikz-3dplot}
\usepackage{pgfplots}
\author{VincentZhang}  % 作者
\date{2019.7.30}  %定义时间
\title{流体力学}  %文档标题
\begin{document}

\maketitle
前言，这篇文章是2007年Siggraph的课程文档(Course Note),从头到底很详细的讲解了怎么用计算机模拟流体(烟和水等等)。
原文地址： \url{https://www.cs.ubc.ca/~rbridson/fluidsimulation/fluids_notes.pdf}

\section{第一章 流体力学公式}
流体力学中最重要的公式是Navier-Stokes 公式:
\begin{equation}
\frac{\partial{\vec{u}}}{\partial{t}}+\vec{u}\cdot \nabla{\vec{u}}+\frac{1}{\rho}\nabla{p}=\vec{g}+\nu\nabla\cdot\nabla\vec{u} \label{momentumequation}
\end{equation}
\begin{equation}
\nabla\cdot\vec{u}=0 \label{incompressibilitycondition}
\end{equation}

\subsection{符号含义}
其中$\vec{u}$是流体的速度。\par
$\rho$是流体的密度，大家都熟悉，如果是水的话，其值为$1000kg/m^3$. 如果是空气的话，其值为$1.3kg/m^3。$\par
$p$是压力，流体对内对外的压力。\par
$vec{g}$是大家都熟悉的重力加速度，一般性就是中学书上的值$(0,-9.81,0)m/s^2$。 从这个向量表示也行，我们这里y轴像上。x- 轴，y- 轴是水平的。$\vec{g}$有时候大家也会叫他"体作用力"\par
$\nu$是“静态粘度”。顾名思义，这个参数表达的是流体有多粘稠。像糖浆这样的流体这个值很高，像酒精这样的流体这个值很低。学术点说，这个参数反映了流体抗拒形变的程度。一个极端的例子是沥青，网上不是有个段子，有个科学家等了一辈子想看一颗沥青掉下来的过程，最后到死都没有实现。另一个更加极端的例子是玻璃，玻璃其实也是一种流体，有很多几百年老教堂的玻璃窗，下面比上面厚，这就是流体流动的结果，但是大家懂的，要观察玻璃滴下来，估计这个老教授要等到宇宙尽头了。
\subsection{动量方程}
Navier-Stokes里的第一条方程(\ref{momentumequation})，其实是一条向量方程，另有一个名字叫做"动量方程"，所以看这条方程的时候，千万要注意变量上面的箭头。其实这个方程就是变形的牛二方程$\vec{F}=m\vec{a}$。 这个方程告诉了我们流体在各种作用力之下是怎么运动的。显然这条方程比较复杂，这一节将把这个方程拆开一项项给大家讲解。后一章节，我们将介绍(\ref{incompressibilitycondition})，这个方程叫做“不可压缩条件”。\par
现在先假设我们用粒子系统去模拟流体(实际上后面的章节有讲怎么具体去模拟，这里作此假设只是进行理论推导方便)。每一个粒子，都可以被理解为一个小小的"分子团",这个“分子团”的质量为m，体积为V(这点很重要，注意我们不是用单个分子去模拟粒子，而是一个小小的分子团！),速度为$\vec{u}$。 根据牛二定理，只要我们知道了这个“分子团”上面的所有的力，根据$\vec{F}=m\vec{a}$ 我们就能知道这个“分子团”的加速度了。其中加速度，我们用这种奇怪的方式定义：\begin{equation}
\vec{a}\equiv\frac{D\vec{u}}{Dt}
\end{equation}
这里面大写的D，叫做物质导数或者叫随体导数。如果你能打开这个链接的话，Wiki上有很好的解释\url{https://en.wikipedia.org/wiki/Material_derivative}。 百度百科上的解释是这样的：\url{https://baike.baidu.com/item/%E9%9A%8F%E4%BD%93%E5%AF%BC%E6%95%B0} \par
简单来说，随体导数是流体力学中的术语。研究的是流体在某点的力学状态时,常考虑这个点周围很小范围内的物质（也就是我们说的“分子团”）随时间变化的变化率。比如这个”分子团“的体积随时间的变化率，再如”分子团“组成的平面随着时间的变化率等等。\par
用随体导数改写的牛二定理如下：
\begin{equation}
m\frac{D\vec{u}}{Dt}=\vec{F}
\end{equation}
OK,接下来我们就来看下粒子上受到了哪些力。最简单的当然是重力：$m\vec{g}$。但是这肯定不是唯一的力，其他粒子也对这个粒子有作用力。\par
第一种来自其他粒子的力，是压力。高压区域的粒子持续不断的给低压区域的粒子施加压力，比如正是由于有心脏不断跳动，向血液施加压力，血液才能流遍全身)。请注意，我们这里的压力，考虑的是合力，具体这个力是从哪个粒子来的并不重要。大家都挤过地铁吧，想象我们现在站在一节塞满了人的地铁车厢里面，真的是塞得满满当当的。这时候突然你的左手边开门了，瞬间你左边的人都走光了，这时候你会受什么力呢？当然是从右向左的力啦，你右边的人也想下车但是被你挡住了啊，只能推你！\par
具体到流体的粒子，假设流体受到的总压力分布为p(注意，这是一个矢量场，不同的位置有不同的压力值), 那么在某点的压强是多少呢？在该点对压力取梯度就可以了，也就是$-\nabla p$，那么我们这个”分子团“上面受到的总压力是多少呢？理论上讲是对$-\nabla p$在整个粒子团的表面取积分，这么做很难，所以我们一般就简简单单乘以体积进行近似。结果粒子上的总压力为:$-V\nabla p$。负号表示这个力是粒子团抵抗外界压力的力，压力的存在主要是因为粒子团想要维持自己的体积，这一点在后续”不可压缩条件“这部分会有更详细解释。\ par
第二种来自其他粒子的力为粘性力，粘性力的主要作用是抵制流体的形变。粘性力存在的原因应该是流体内部的摩擦力。其效果是让瘤体内的粒子(分子团)的速度尽量跟周围粒子的平均速度一样，也就是说，尽量降低流体内部的速度差。如果你做过图像处理，或者了解热传导方程或扩散方程，那就应该能知道，数学上描述某一个特定点的数量与周围点平均值的差距是拉普拉斯算子$\nabla\cdot\nabla$，这个量在这里是速度，因此这个部分是$\nabla\cdot\nabla\vec{u}$。下一节会更详细解释拉普拉斯算子，别着急。更压力的情况差不多的是，粘性力也需要对整个粒子进行积分。因此我们得到了：$V\nu\nabla\cdot\nabla\vec{u}$，其中$\nu$是流体的动态粘性系数，由很多因素决定，常见液体的粘度随温度升高而减小，常见气体的粘度随温度升高而增大。\par
总结下，一个粒子团总共受到三种力，重力、压力、粘性力。把上面的所有项都放在一起，我们就得到了：
\begin{equation}
m\frac{D\vec{u}}{Dt}=m\vec{g}-V\nabla{p}+V\nu\nabla\cdot\nabla\vec{u}
\end{equation}
等式两边除以体积，得到：
\begin{equation}
\rho\frac{D\vec{u}}{Dt}=\rho\vec{g}-\nabla{p}+\nu\nabla\cdot\nabla\vec{u} \label{momentumequation_1st}
\end{equation}
其中$\rho$为流体密度。

\fbox{
\parbox{\textwidth}{
简单解释下拉普拉斯算子$\nabla\cdot\nabla$，详细的解释请参见多维微积分教材 \\
拉普拉斯算子，记作$\nabla\cdot\nabla$、$\nabla^2$ 或者$\Delta$，为梯度的散度。顾名思义，他的含义是先对函数f(一般至少是二维函数)做梯度$\nabla{f}$, 再对这个梯度函数做散度$\nabla\cdot\nabla{f}$。\\
这么说还是很抽象，我们来考虑下二维离散的图片，在某一点的拉普拉斯算子(四联通)可以这样定义：
\begin{equation}
\nabla\cdot\nabla{f}=[f(x+1,y)+f(x-1，y）+f(x,y+1)+f(x,y-1)]-4f(x,y) \label{laplacian}
\end{equation}
如果用卷积核的方式来表示，就是：
$$
\left[
\begin{matrix}
0 & -1 & 0 \\
-1 & 4 & -1 \\
0 & -1 & 0
\end{matrix}
\right]
$$
从(\ref{laplacian})可以很明显看出，拉普拉斯算子衡量的是一个点的数值偏离周围点数值平均值的程度。在图像处理上，主要用来做边缘检测。
}
}

在式(\ref{momentumequation_1st})的两边除以$\rho$，得到下式:
\begin{equation}
\frac{D\vec{u}}{Dt}=\vec{g}-\frac{1}{\rho}\nabla{p}+\frac{\nu}{\rho}\nabla\cdot\nabla\vec{u}
\end{equation}
其中的$\frac{\nu}{\rho}$叫做静态粘性系数，记作$\nu$ 因为除了液体的密度，所以显然密度越大的流体，这个值越高。代入上式，再整理下得到：
\begin{equation}
\frac{D\vec{u}}{Dt}+\frac{1}{\rho}\nabla{p}=\vec{g}+\nu\nabla\cdot\nabla\vec{u}
\end{equation}

\subsection{拉格朗日视角与欧拉视角}
当需要考虑可变性的连续体运动的时候(流体或者那种会变形的固体，比如布料等等。我们这篇文章讲的是流体，后文没有特别注明的情况下都用流体去考虑)，有两种视角，拉格朗日视角和欧拉视角。\par
拉格朗日视角的观点基本上就是让观察者变身成流体里面一个"分子团"，假设你就是这个"分子团"，那么你的位置$\vec{x}$、速度$\vec{u}$会是什么？从这个角度去考虑流体里的量的变化的方法，叫做拉格朗日视角。\par
欧拉视角，基本上主要考虑空间中固定点的量，因为这个点是固定的其位置不会变化，考虑流经这个点的其他量比如速度$\vec{x}$、 密度$\rho$,温度等等的变化。 比如，如果正好一股暖流从这个固定点经过，如果我们考虑这点的温度，会看到它不断上升。但是如果用拉格朗日视角一个个粒子去看，其实整个流体里面没有一个粒子的温度有变化。\par
一个更有趣的粒子是天气预报，拉格朗日视角其实就像是个探空气球，跟着风到处飞。欧拉视角就像是那些放在地面上，测吹过的空气的温度湿度的百叶箱。\par
从数值模拟的角度，拉格朗日视角其实就是做一个粒子系统(可能用一个网格连接起来)，欧拉视角则是一个在空间中不随流体运动的固定格子，考虑的是每个格点上的物理量。\par
这么看起来，拉格朗日视角似乎更加好理解也更简单，那为什么我们还需要引入欧拉视角呢？主要有如下原因：
\begin{itemize}
\item 用欧拉视角，比较有助于理论分析压力梯度和粘性力。
\item 由于流体形状多变，在一个固定网格上对各种量进行差分等数值模拟也会相对比较简单。
\end{itemize}
把这两种视角联系起来的关键是物质导数。让我们先从拉格朗日视角开始描述下物质导数：有一个“分子团”，它的位置是$\vec{x}$，速度是$\vec{u}$。 假设这个粒子拥有某个物理量q(可能是压力，可能是密度，可能是温度，这里的讨论不限于具体是哪个物理量，只是做一个统一的理论分析)。这样函数$q(t,\vec{x})$指的就是在t时刻，经过$\vec{x}$的物理量q的值，如果是一个固定点$\vec{x}$的话，显然，这就是个欧拉视角下的变量，其变化率(即该物理量随时间变化的速率)是什么呢？用链式法则算一下：
\begin{equation}
\begin{aligned}
\frac{d}{dt}q(t,\vec{x})&=\frac{\partial{q}}{\partial{t}}+\nabla{q}\cdot\frac{d\vec{x}}{dt} \\
&=\frac{\partial{q}}{\partial{t}}+\nabla{q}\cdot\vec{u} \\
&\equiv{\frac{Dq}{Dt}}
\end{aligned}
\end{equation}
可以看到物质导数有两项，第一项$\frac{\partial{q}}{\partial{t}}$，指的该物理量在$\vec{x}$这点随时间变化的变化率。第二项$\nabla{q}\cdot\vec{u}$ 指是该物理量随着流体运动的变化率。\par
注意物质导数是向量，当然我们可以把它在3d的坐标系中展开(可以想象一下，在四维空间，流体是怎样的呢？五维、六维以至于无穷维呢？)，注意到$\nabla{q}=(\frac{\partial{q}}{\partial{x}}，\frac{\partial{q}}{\partial{y}},\frac{\partial{q}}{\partial{z}})$，将它与速度向量$\vec{u}=(u,v,w)$做点积可以得到：
\begin{equation}
\frac{Dq}{Dt}=\frac{\partial{q}}{\partial{t}}
                +u\frac{\partial{q}}{\partial{x}}
                +v\frac{\partial{q}}{\partial{y}}
                +w\frac{\partial{q}}{\partial{z}} \label{materialderivative}
\end{equation}
显然在2D空间中，上式最后一项$w\frac{\partial{q}}{\partial{z}}$ 为零，可以去掉。\par
式(\ref{materialderivative})表示的某个物理量随着"分子团"在速度场中$\vec{u}$中运动的情况，这种运动叫做对流。如果某个物理量，它在拉格朗日视角下没有任何变化(比如假设外界温度不变的情况下，温度在空气中随着风而传播的过程)，那么我们可以得到对流方程：
\begin{equation}
\begin{aligned}
\frac{Dq}{Dt}\equiv{0} \\
i.e. \frac{\partial{q}}{\partial{t}}+\nabla{q}\cdot\vec{u}=0
\end{aligned}
\end{equation}

\subsection{一个例子}
写一堆公式都不如直接来个例子让人好理解，所以我们这里先举个温度的例子。因为这个具体的例子是用的温度这个物理量，所以这里不用q而用T。假设这个温度场是这样的：
\begin{equation}
T(x)=10x
\end{equation}
也就是说，越在右边，温度越高，左边温度低。在坐标原点，温度为零，在图的右边$x=100$ 的地方，温度为100。假设有一个稳定的速度为c的风向右吹，这样的话，流速的分布是这样的：
\begin{equation}
\vec{u}=c
\end{equation}
为简单起见，假设空气中每个粒子本身的温度不发生变化，只是移动。就像上章说过的，这种情况下，用拉格朗日视角看，随体导数为零。
\begin{equation}
\frac{DT}{Dt}=0
\end{equation}
展开可以得到：
\begin{equation}
\begin{aligned}
\frac{\partial{T}}{\partial{t}}+\nabla{T}\cdot\vec{u}=0 \\
\frac{\partial{T}}{\partial{t}}+10\cdot{c}=0 \\
\Rightarrow \frac{\partial{T}}{\partial{t}}=-10c \label{example}
\end{aligned}
\end{equation}
从式(\ref{example})可以看到，在空间中一个固定点，温度的变化率是-10c。如果风速降低到c=0，那么整个流体都不发生任何变化。如果向右吹的速度c=1，在固定点的温度变化率为-10度每秒。如果风吹的更大一点c=20，那么在每个固定点的温度变化率为-20度每秒。可以看到即使拉格朗日视角下，温度变化为零，欧拉视角下温度仍然在流体速度的作用下不断变化。
\subsection{对流向量}
初学者经常困惑的一点是在向量的情况下，随体导数的意义，例如颜色RGB的随体导数，或者更明确的说，速度向量场$\vec{u}$的随体导数是什么含义。最简单的答案：把每个分量单独处理。让我们把颜色向量$\vec{C}=(R,G,B)$，那么其随体导数为：
\begin{equation}
\frac{D\vec{C}}{Dt}=\begin{bmatrix}
    DR/Dt \\
    DG/Dt \\
    DB/Dt
\end{bmatrix}=\begin{bmatrix}
\partial{R}/\partial{t}+\vec{u}\cdot\nabla{R} \\
\partial{G}/\partial{t}+\vec{u}\cdot\nabla{G} \\
\partial{B}/\partial{t}+\vec{u}\cdot\nabla{B}
\end{bmatrix}=\frac{\partial{\vec{C}}}{\partial{t}}+\vec{u}\cdot\nabla\vec{C} \label{advect_vector}
\end{equation}
接下来，我们都速度进行一下同样的操作，基本上没什么大区别，就把上两次出现的$\vec{C}$用$\vec{u}$来代替就行了。用$\vec{u}=(u,v,w)$带入，得到:
\begin{equation}
\frac{D\vec{u}}{Dt}=\begin{bmatrix}
Du/Dt \\
Dv/Dt \\
Dw/Dt
\end{bmatrix}=\begin{bmatrix}
\partial{u}/\partial{t} + \vec{u}\cdot\nabla{u} \\
\partial{v}/\partial{t} + \vec{u}\cdot\nabla{v} \\
\partial{w}/\partial{t} + \vec{u}\cdot\nabla{w}
\end{bmatrix}=\frac{\partial{\vec{u}}}{\partial{t}}+\vec{u}\cdot\nabla{\vec{u}}
\end{equation}
当然，我们可以进一步展开右边的梯度项得到下式：
\begin{equation}
\frac{D\vec{u}}{Dt}=\begin{bmatrix}
\frac{\partial{u}}{\partial{t}} + u\frac{\partial{u}}{\partial{x}} + v\frac{\partial{u}}{\partial{y}} + w\frac{\partial{u}}{\partial{z}} \\
\frac{\partial{v}}{\partial{t}} + u\frac{\partial{v}}{\partial{x}} + v\frac{\partial{v}}{\partial{y}} + w\frac{\partial{v}}{\partial{z}} \\
\frac{\partial{w}}{\partial{t}} + u\frac{\partial{w}}{\partial{x}} + v\frac{\partial{w}}{\partial{y}} + w\frac{\partial{w}}{\partial{z}}
\end{bmatrix}
\end{equation}

\subsection{不可压缩性}
真正的流体体积都多多少少会发生变化。实际上，声波就是因为流体体积的变化而产生的。有些书上可能会说气体的体积可压缩而液体的体积不可压缩，但实际上这个说法是不精确的，两者的体积都可能发生变化，否则在水下就不可能听到声音了。\par
然而，液体体积的变化确实不会很大。即使是气体，如果不用泵的话或者不是在声爆等极端情况下，体积的变化也不会特别大。流体在这些体积可压缩情况下的行为是非常复杂难以模拟的，除了声波这个例子，其他情况也基本不会在正常生活中出现。即使是声波，流体的体积变化也很小，对于动画模拟来说基本可以忽略不计。所以，最后结论，如果我们做流体模拟的动画的话，为了简化期间，我们还是认为液体是不可压缩的。\par
那么数学上，流体是不可压缩是什么意思呢？就是指的流体的体积不可变。在某个时间点，选取任意流体团，如果其体积为$\Omega$，表面积为$\partial{\Omega}$。在数学上，我们可以通过对流体的速度在法向量方向的积分来衡量体积的变化：
\begin{equation}
\frac{d}{dt}Volume(\Omega)=\int\int_{\partial{\Omega}}{\vec{u}\cdot{\hat{n}}} \label{volume}
\end{equation}
既然我们考虑的是不可压缩流体，那么显然式(\ref{volume})的结果应该是零，也就是说:
\begin{equation}
\int\int_{\partial{\Omega}}{\vec{u}\cdot{\hat{n}}}=0 \label{volumezero}
\end{equation}
如果处理这个积分呢？我们需要散度定理把这个面积分转化为体积分，我们会得到：
\begin{equation}
\int\int\int_{\Omega}\nabla\cdot\vec{u}=0
\end{equation}

~~~~~~~~这里补充下散度和散度定理~~~~~~~~~~~~~~~~~~~~~~


接下来是见证奇迹的时刻，上面对流体团$\Omega$的选择是任意的，也就是说，不管是对整个太平洋的水，还是对一汤勺的水，还是对肉眼看不见的浮游生物血管内壁的一个细胞内部的一个细胞器里面的一点点水，都成立。如果是这样，那么我们可以看出只有一种情况会让上面的式子始终为零，那就是积分符号里面的函数是零，也就是说，在流体内的任意地方：
\begin{equation}
\nabla\cdot\vec{u}=0 \label{incompressiblecondition}
\end{equation}
如果回头看Navier-Stokes公式,其第二条正是式(\ref{incompressiblecondition})\par
满足不可压缩条件的向量场被称为"无散度场"，其实流体中的压力的主要作用和效果，就是随时随地保证"不可压缩条件"。如果对理论力学比较熟悉的话，这个其实就是一个限制，压力场则可以被视为一个拉格朗日乘子。

~~~~~~~这里补充下拉格朗日乘子法~~~~~~~~~~~~~~~~~~~~~

\par
压力项只出现在Navier-Stokes公式的动量方程部分，结合不可压缩条件，让我们对动量方程两边取散度：
\begin{equation}
\nabla\cdot\frac{\partial{\vec{u}}}{\partial{t}}+\nabla\cdot(\vec{u}\cdot\nabla{\vec{u}})+\nabla\cdot\frac{1}{\rho}\nabla{p}=\nabla\cdot({\vec{g}+\nu\nabla\cdot\nabla\vec{u}})
\end{equation}
\par
对第一项，可以把这个散度和偏微分做交换:
\begin{equation}
\frac{\partial}{\partial{t}}\nabla\cdot\vec{u}
\end{equation}
结合不可压缩条件，显然这一项应该是0。 代回去重新整理下，我们就得到了压力方程:
\begin{equation}
\nabla\cdot\frac{1}{\rho}\nabla{p}=\nabla\cdot(-\vec{u}\cdot\nabla{\vec{u}}+{\vec{g}+\nu\nabla\cdot\nabla\vec{u}})
\end{equation}

\subsection{去除粘度项}
在一些情况下，粘性力是非常重要的:比如如果需要模拟的是蜂蜜或者小水滴，那么粘性力是个不可忽视的因素。但是在大多数其他情况下，粘性力的因素很小。显然，不管从哪个角度看，让公式变得越简单越好。所以，在这里我们将去除粘度项。没有粘度项的Navier-Stokes公式有另一个名字叫做"欧拉方程"(又见欧拉方程，欧拉这辈子这是丰富！！)，而这样的理想化的流体被成为"无粘度流体"。为了让公式简单化，我们重新把随体导数一起带回去：
\begin{equation}
\frac{D\vec{u}}{Dt}+\frac{1}{\rho}\nabla{p}=\vec{g} \\
\nabla\cdot\vec{u}=0
\end{equation}

这组方程，才是我们在流体模拟中经常要用的方程。
\subsection{边界条件}
流体都是有边界的，这里有两种情况，流体的边界是"墙"(或者盒子)，另一种情况是"自由边界"。为了简单起见，我们将不会考虑两种流体之间的边界情况。\par
对于"墙"这种情况，用流体的速度做限制比较合理：流体最好不能流进或者流出固体，也就是说，流体在边界上的法向量速度为零。
\begin{equation}
\vec{u}\cdot\hat{n}=0
\end{equation}
\par
当然，有些情况下墙(或者盒子)本身也是会移动的，那样的话，流体在法向量上的速度应该跟固体一样：
\begin{equation}
\vec{u}\cdot\hat{n}=\vec{u}_{solid}\cdot{\hat{n}}
\end{equation}
\par
其中$\hat{n}$代表了固体的法向量。有时候这个式子叫做"不粘锅"条件，因为很显然流体仍然可以在固体表面流动(只是不能进出固体，确实很像不粘锅)。回忆下压力？之前提过，压力就是让流体符合不可压缩条件的力，显然我们应该再加上另一条，压力也是让流体符合边界条件的力。\par
如果流体和固体之间有粘性，那么故事将变的很复杂，从边界条件的角度，如果固体不动的话$\vec{u}=0$，如果固体运动的话$\vec{u}=\vec{u}_{solid}$
\par
另一个有趣的边界条件是自由边界。自由边界的意思指的基本上是指没有边界条件，让流体自由流动的结果。例如，如果我们要模拟的是烟雾或者泼水。这些情况下，流体与固体没有接触，事实上这种情况下一般有两种流体。但是如前所述，简单起见，我们并不想考虑两种流体的边界。在这种情况下，边界上就是没有压力的地方，也就是说$p=0$，也就是说，速度的角度，我们不打算控制流体。
\par
如果我们想要模拟的是很小的液滴，表面张力就变的非常明显了。表面张力也是个很复杂的话题，简单来说，液体越"弯曲",其上的表面张力越大(所以，小泡泡其实比较容易爆炸，所以大家比较难看到大泡泡)。液体的“弯曲”程度，数学上用曲率来表示。这样我们就能得到：
\begin{equation}
[p]=\gamma\kappa
\end{equation}
p两边的[]代表这是个跳变，在液体内部压力依然符合之前的讨论，只是到了液滴表面，压力骤升。$\kappa$是液滴的曲率，单位是1/m。 $\gamma$ 是表面张力系数(水-空气的表面张力系数大概是$\gamma\approx 0.073N/m$)。
\par
在模拟自由表面的时候，有一个非常有趣而且很复杂的问题，泡泡会爆炸。也有一些技巧去模拟这个过程，不过我们这里不会涉及。

\section{第二章 数值模拟综述}
上一章一通推公式，可是计算机又看不懂公式，怎么做呢？当然需要用计算机去离散化处理流体。
\subsection{拆分}
为了数值求解复杂微分方程，一个比较常见的做法是拆分，也就是说把微分方程的各个项分开分别处理。如果某个物理量的变化率是多个项之和，那我们可以数值更新每一项，然后把他们加起来。
\par 这里举个非常简单的例子，看一下拆分是怎么工作的。假设有如下常微分方程：
\begin{equation}
\frac{dq}{dt}=1+2
\end{equation}
这个方程当然有很简单的解析解:$q(t)=3t+q(0)$，但我们研究下怎么用数值的方式来解这个方程。让我们把这个方程拆成两步，基本上就是简单的前向欧拉法:
\begin{equation}
\begin{aligned}
\tilde{q}=q^n+1\Delta{t} \\
q^{n+1}=\tilde{q}+2\Delta{t}
\end{aligned}
\end{equation}
其中$q^n$是第n步时候得到的值，$\Delta{t}$是两步之间的时间差。$\tilde{q}$计算第n步的时候的中间变量，只更新了第一项，没有更新第二项。这个例子当然非常的简单，这么做似乎没有任何意义，但是如果微分方程很复杂的话，那么这么做就很有意义了。接下来，让我们看一个稍微复杂点的例子：
\begin{equation}
\frac{dq}{dt}=f(q)+g(q)
\end{equation}
\par 其中f()和g()是关于q的黑盒函数。我们这样子把他拆成前向欧拉方法：
\begin{equation}
\begin{aligned}
\tilde{q}=q^n+\Delta{t}f(q^n) \\
q^{n+1}=\tilde{q}+\Delta{t}g(\tilde{q})
\end{aligned}
\end{equation}
这个例子里面，显然这么分两步走好像也没有任何意义。那么让我们在看下下面的例子：
\begin{equation}
\begin{aligned}
\frac{dr}{dt}=f(r) \\
\frac{ds}{dt}=g(s)
\end{aligned}
\end{equation}
假设我们用上面的方法去处理，假设$F(\Delta{t},r)$ 和$G(\Delta{t},s)$ 是对上述两个函数更新的方法，那么有如下的前向更新的方法:
\begin{equation}
\begin{aligned}
\tilde{q}=F(\Delta{t},q^n) \\
q^{n+1}=G(\Delta{t},\tilde{q})
\end{aligned}
\end{equation}
大部分复杂微分方程都没有办法求解出解析解，全局求数值解往往也很难，这种情况下拆分开来求解往往更为合理。
\subsection{拆分流体方程}
\par
接下来我们可以拆分不可压缩条件下的流体方程了。具体的，我们将把流体方程分为对流部分，物体力(重力)部分，和压力/不可压缩条件部分这三部分。
\begin{equation}
\begin{aligned}
\frac{Dq}{Dt}=0    &&(\mbox{对流项})\\
\frac{\partial{\vec{u}}}{\partial{t}}=\vec{g} &&(\mbox{物体力})\\
\frac{\partial{\vec{u}}}{\partial{t}}+\frac{1}{\rho}\nabla{p}=0\quad \mbox{s.t.}\quad \nabla\cdot\vec{u}=0 &&(\mbox{压力项})
\end{aligned}
\end{equation}
\par
注意到在对流项部分，我们没有写速度$\vec{u}$而是用了q 表示，这主要是想覆盖所有满足对流条件的物理量(即，用拉格朗日视角追随某个粒子，这个物理量不变，比如温度等等)。
求解对流项部分，我们可以称其为函数$advect(\vec{u},\Delta{t},q)$，其含义为在速度场v 在时间间隔$\Delta{t}$ 中对流物理量q。后面的第三章会详细介绍怎么做。

求解物理力这部分,我们可以简单前向欧拉方法解决。

求解压力项这部分，之后会引入一个叫做$project(\Delta{t},\vec{u})$ 的方法来求解，这个方法计算出合适的压力，使得速度场$\vec{u}$无散度，同时满足固液(也就是墙壁)的边界条件。第四章将会处理这一部分(同时会解释这个函数名字project的意义)。
\par
把这些东西都放在一起，就可以搭起来整个流体模拟算法的框架了：
\begin{itemize}
\item 初始化一个无散度的速度场$\vec{u}^{(0)}$
\item 对每个时间步n=0,1,2,...
\subitem 决定从$t_n$到$t_{n+1}$经过了多长时间$\Delta{t}$
\subitem 设置$\vec{u}^A=advect(\vec{u}^n,\Delta{t},\vec{u}^n)$
\subitem 设置$\vec{u}^B=\vec{u}^A+\Delta{t}\vec{g}$
\subitem 设置$\vec{u}^{n+1}=project(\Delta{t},\vec{u}^B)$
\end{itemize}
\subsection{时间步长}
上述算法里面第一步是决定时间步长$\Delta{t}$。第一点要考虑的是不能让模拟的时间超过真正的动画帧的时间，假设我们选了一个$\Delta{t}$使得$t_n+\Delta{t}>t_{frame}$，我们应该做一个截断$\Delta{t}=t_{frame}-t_n$然后设一个标志位表明我们已经达到了这一帧的结束。(注意下，如果要做判断相等，不能直接用等号=来判断，因为浮点数有误差。)在每帧结束，我们可能可以做些特别的事情，比如保存状态到磁盘或者渲染到屏幕。
\par
关于这个截断，我们希望选择合适的$\Delta{t}$满足模拟算法各个步骤(对流，体作用力等等)的需求。后面的章节会讨论这些需求具体是什么。不管怎么说，让步长尽量小总是个安全的选择。
\par
然而，在有些情况下，由于我们有性能上的要求，因此每帧不能选太小的步长。比如，如果每帧只能模拟三次，那我们要确保$\Delta{t}$至多是帧时长的1/3.
\subsection{网格}
迄今为止，我们只讨论了时间上怎么离散化，这一节我们将在空间上做离散化。后续的章节会对这个问题做更进一步的讨论，我们将先介绍下基本的网格结构。\par
在计算流体力学的早期发展阶段，Harlow和Welch介绍了一种很好的空间网格结构MAC网格(Marker-and-Cell)去高效的求解不可压缩流体问题。\par
MAC网格是一个“交错”的网格,也就是说，不同的变量被存在不同的位置。让我们先看看二维的例子。网格(i,j)的压力在网格的中心取样，记作$p_{i,j}$。 速度按照笛卡尔坐标系的方向被拆成两部分。水平分量$u$在垂直网格面的中心被采样，例如$u_{i+1/2,j}$指的是在网格(i,j)和(i,j+1)中间点的速度。同样的垂直分量$v$是在水平网格的中心被采样，例如$v(i,j+1/2)$指的是网格(i,j)和(i,j+1)中间点的速度。注意到对任意网格(i,j)，每个面中心的法向速度都被采样到了，这样做的好处在于，我们将很容易估计通过这个面流进流出这个网格的流量。
\par

\begin{tikzpicture}[scale=2]
\draw [->] (0.7,0.7) -- (3,0.7);
\draw [->] (0.7,0.7) -- (0.7,3);
\draw[step=2cm] (2.1,1.51) grid (5.99,5.99);
\filldraw [black] (1.51,3.75) circle (1pt);
\filldraw [black] (2.25,3.75) circle (1pt);
\draw [->] (2.25,3.75) -- (2.75,3.75);
\draw (2.25,3.75) node[anchor=north west] [black]{$u_{i-1/2,j}$};
\filldraw [black] (3,3.75) circle (1pt);
\draw (2.5,2.5) node[anchor=south] [black]{$p_{i,j}$};
\filldraw [black] (3.75,3.75) circle (1pt);
\draw [->] (3,2.5) -- (3.2,2.5);
\draw (3,2.5) node[anchor=north west] [black]{$u_{i+1/2,j}$};
\filldraw [black] (4.5,3.75) circle (1pt);
\draw (3.5,2.5) node[anchor=south] [black]{$p_{i+1,j}$};

\filldraw [black] (2.5,1.5) circle (1pt);
\filldraw [black] (2.5,2) circle (1pt);
\filldraw [black] (2.5,3) circle (1pt);
\filldraw [black] (2.5,3.5) circle (1pt); \label{fig:mac_grid_2d}
\end{tikzpicture}


考虑三维的情况，MAC网格也是用类似的方法构建的，网格中心点处存储压力值，每个面的中心点处存储速度在这个方向上的分量。
\par

\tdplotsetmaincoords{-20}{0}
\begin{tikzpicture}[z=-1cm,thick,grid/.style={very thin,gray},tdplot_main_coords]
\tdplotsetrotatedcoords{0}{-20}{0}

\draw[->,tdplot_rotated_coords,color=black] (0,0,0) -- (7,0,0);
\draw[tdplot_rotated_coords] (7,0,0) node[anchor=south] [black]{x};
\draw[->,tdplot_rotated_coords,color=black] (0,0,0) -- (0,7,0);
\draw[tdplot_rotated_coords] (0,7,0) node[anchor=south] [black]{y};
\draw[->,tdplot_rotated_coords,color=black] (0,0,0) -- (0,0,7);
\draw[tdplot_rotated_coords] (0,0,7) node[anchor=south] [black]{z};
% back of the cube
\draw[tdplot_rotated_coords,color=black] (2.5,3,0) -- (8.5,3,0);
\draw[tdplot_rotated_coords,color=black] (3,2.5,0) -- (3,8.5,0);
\draw[tdplot_rotated_coords,color=black] (2.5,8,0) -- (8.5,8,0);
\draw[tdplot_rotated_coords,color=black] (8,8.5,0) -- (8,2.5,0);

%top of the cube

\draw[tdplot_rotated_coords,color=black] (3,8,-0.5) -- (3,8,5.5);
\draw[tdplot_rotated_coords,color=black] (8,8,-0.5) -- (8,8,5.5);
\draw[tdplot_rotated_coords,color=black] (2.5,8,5) -- (8.5,8,5);

% front of the cube
\draw[tdplot_rotated_coords,color=black] (3,8.5,5) -- (3,2.5,5);
\draw[tdplot_rotated_coords,color=black] (8,8.5,5) -- (8,2.5,5);
\draw[tdplot_rotated_coords,color=black] (2.5,3,5) -- (8.5,3,5);

% two side lines
\draw[tdplot_rotated_coords,color=black] (3,3,5.5) -- (3,3,-0.5);
\draw[tdplot_rotated_coords,color=black] (8,3,5.5) -- (8,3,-0.5);
\end{tikzpicture}
\par
至于为什么我们要用这么绕的方式做网格将会在第四章详细说，简单来说主要的作用是让网格的“中心差异”更为精确，今儿使得压力梯度和速度场的散度更为精确，从而避免这种方法的缺点。考虑一个1d的例子：估算一个量q在格子$...q_{i-1},q_i,q_{i+1}...$在格子i处的微分值$\partial{q}/\partial{x}$。直接从微分的定义出发的话，很自然能想到：
\begin{equation}
(\frac{\partial{q}}{\partial{x}})_i\approx \frac{q_{i+1}-q_{i-1}}{2\Delta x}  \label{differential_grid}
\end{equation}
用泰勒展开能够看出来，这种方法的精度能达到$O(\Delta x^2)$级别，而如果用普通的欧拉前向或者后向来算，比如这个方式:
\begin{equation}
(\frac{\partial{q}}{\partial{x}})_i\approx \frac{q_{i+1}-q_{i}}{\Delta x}  \label{euler_grid}
\end{equation}
其精度只能达到$O(\Delta x)$级别。但是式(\ref{differential_grid})有一个最大的问题是计算的物理量在格子i,但是这个式子完全忽略了$q_i$！这是非常糟糕的一件事情，假设我们要算一个常量函数的微分值(结果一秒钟就能看出来，就是零)。如果我们用式(\ref{differential_grid})去对原函数做约束，那么q的值未必一定是个常数，即使${q_i}$的值和$q_{i-1}$和$q_{i+1}$的差异非常大，结果可能仍然是0，只要保证$q_{i-1}=q{i+1}$就行了。比如这个函数值为$q_i=(-1)^i$，显然这个函数是个非常“坑坑洼洼”的函数，但是其按照式\ref{differential_grid}得到的微分值依然为0，这显然是一件非常错误的事情。另一方面，式(\ref{euler_grid})反而能够精确的保证只有常函数微分值才为零函数。这个问题叫做"非正常零值空间"问题：这个名字真是绕，谁想出来的。。。   其实这个问题本身很简单，就是描述式(\ref{differential_grid}的零函数不一定是常函数而已。
\par
那么我们应该怎么既保持二阶精度$O(\Delta x^2)$,又解决这个"非正常零值空间"问题呢？答案是用上面讲的交错网格的方式:在格子的边或者面上对物理量q做采样$q_{i+1/2}$。那么很自然的微分值就变成了:
\begin{equation}
(\frac{\partial{q}}{\partial{x}})_i\approx \frac{q_{i+1/2}-q_{i-1/2}}{\Delta x}
\end{equation}
用这种方法，我们就不会导致"非正常零值空间"又能保证二阶精度。
\par
交错MAC网格这种做法处理压力和其他非压缩量非常完美，但是用在别的地方却有点尴尬。比如就说速度，因为我们只存储了面中心点的速度，如果想知道微团本身的速度，就必须用各种插值的方法才能得到。在空间中任意点上，我们一般会对每个速度分量做双线性或者三线性插值，但因为这几个分量都是分离的，我们需要对几个分量用不同的权重。不过在网格的中心点处，我们可以简单做平均，在二维空间中，结果是：
\begin{equation}
\begin{aligned}
\vec{u}_{i,j}&=(\frac{u_{i-1/2,j}+u_{i+1/2,j}}{2},\frac{v_{i-1/2,j}+v_{i+1/2,j}}{2}) \\
\vec{u}_{i+1/2,j}&=(u_{i+1/2,j},\frac{v_{i,j-1/2}+v_{i,j+1/2}+v_{i+1,j-1/2}+v_{i+1,j+1/2}}{4}) \\
\vec{u}_{i,j+1/2}&=(\frac{u_{i-1/2,j}+u_{i+1/2,j}+u_{i-1/2,j+1}+u_{i+1/2,j+1}}{4},v_{i,j+1/2}) \\
\end{aligned}
\end{equation}
\par
三维空间也是类似，不过看起来更加复杂
-----补充三维公式-----

\section{第三章 对流算法}
在前面的章节里面，我们看到流体模拟的很重要一步是数值求解对流方程：
\begin{equation}
Dq/Dt=0
\end{equation}
我们会把这一步骤封装成一个函数
\begin{equation}
q^{n+1}=advect(\vec{u},\Delta{t},q^n)
\end{equation}
$\vec{u}$是速度场(利用MAC网格做离散化),$\Delta{t}$是时间步长,$q^n$是在时刻n的时候某个物理量q的值，类似的$q^{n+1}$是在n+1时刻这个物理量q在这个速度场中的值。
\par
我们当然可以用暴力求解的方法去解出$Dq/Dt$，在一维的情况下，将这个微分方程展开得到：
\begin{equation}
\frac{\partial{q}}{\partial{t}}+u\frac{\partial{q}}{\partial{x}}=0
\end{equation}
然后我们可以用差分来代替微分。例如，如果用前向欧拉方法的话，可以得到下面的式子：
\begin{equation}
\frac{q_i^{n+1}-q_i^n}{\Delta{t}}+u^n_i\frac{q^n_{i+1}-q^n_{i-1}}{2\Delta{x}}
\end{equation}
为了解出$q_{n+1}$，整理一下上式，得到：
\begin{equation}
q_i^{n+1}=q_i^{n}-\Delta{t}u^n_i\frac{q^n_{i+1}-q^n_{n-1}}{2\Delta{x}}
\end{equation}
\par
看起来挺美好的，但是如果按照这个方法去做数值模拟的话，将会是个灾难。
\par
首先，前向欧拉方法是不稳定的，也就是说，随便你的$\Delta{t}$取多小，迟早会爆炸(也就是说q的值迟早会变成无穷大)。(背后的数值分析不想在这里介绍，反正我们等会儿会给出一个稳定的方法)
\par
其实这个问题也不单单只是前向欧拉法本身的问题，即使用一种更为稳定的数值方法，或者实际上即使用这个微分方程的精确解去做模拟，这种方法仍然会造成严重的问题。还记不记得上一章节讲过的那个恶心的“非正常零值空间”问题吗？这个问题在这里也存在，也就是说“高频”信号会导致结果的畸变，比如那个函数$(-1)^i$，在空间中会被错误的标记为零值或者接近零值的微分值，因此就不会随着时间的推进而进行值得更新(或者更新的速度极为缓慢)。但是同时，信号里的"低频"部分依然能够被正确的处理，移动速度依然是正常水平。可以想见，最后的结果是低频部分与高频部分会分离，留下来的结果是一堆高频振动的"虚幻"的波纹。毁坏了模拟的结果。
\par
这里并不想更进一步数值上分析造成该结果的原因。我们主要注意到造成这一错误的原因是因为我们只是简单的用了差分去代替微分。为了解决这一问题，我们需要用更为精确的方式去数值化计算空间微分。我们将用一种更为简单，更为偏向物理的求解方法，叫做"半拉格朗日"方法。拉格朗日这个词，肯定能让你想起来在拉格朗日框架下，对流方程$Dq/Dt=0$是完全显然的。假设我们用粒子系统的方式去求解，这个方程是被自动求解出来的。因为当我们在速度场中移动粒子的时候，这个粒子本身并没有发生改变！也就是说，点$\vec{x}$处某粒子的物理量q，正是同一个粒子在前一时刻的物理量q更新来的。
\par
利用这个思路，在我们求解网格点的q值的时候，我们应该搞清楚的是这个粒子原来的q值。这个粒子在速度场$\vec{u}$中运动，它现在在网格点处，那么一个很容易想到的方法就是往回追溯这个点在这一时间片的起点位置。通过这个起点位置我们可以反推出q的值，然后就可以计算出在网格点处q的新值了! 这个起点当然大概率不在网格点上，但是无所谓啦，反正我们总可以通过在网格内插值得到这个任意点的值。
\par
让我们重新慢慢过一遍，同时进行一些公式推导。假设我们要考虑的网格点$\vec{x}_G$。我们想找到q在这点的新的值,叫做$q^{n+1}_G$。从对流方程，假设一个微团最终到达了$\vec{x}_G$，而且它的旧物理量值是$q_P^n$。当他在向量场中移动$\Delta{t}$时间片以后，根据对流方程显然$q_G^{n+1}=q_P^n$。所以，现在的问题是，如何得到$q_P^n$?
\par
第一步是找出这个"虚拟粒子团"是从哪儿来的，这个位置叫做$\vec{x}_P$。这个粒子团的运动符合一般的运动学方程:
\begin{equation}
\frac{d\vec{x}}{dt}=\vec{u}
\end{equation}
这个微团在$\Delta{t}$之后到达的位置，就是$vec{x}_G$。我们可以从位置$\vec{x}_G$沿着速度场$-\vec{u}$(注意这里的符号，表示的就是沿着时间回溯)往过去回溯$\Delta{t}$时间。最简单的方法当然还是前向欧拉法:
\begin{equation}
\vec{x}_P=\vec{x}_G-\Delta{t}\vec{u}_G
\end{equation}
一般来说，前向欧拉法基本也就够了，但是如果想要获得更好的效果的话，我们也可以用更加精确的数值算法，比如变形欧拉法，这是一种龙格库塔(Runge-Kutta)方法的二阶变形。

---------------补充变形欧拉法和龙格库塔方法----------------------------

\par
现在我们已经知道了这个粒子微团的起始位置，接下来我们要计算出其q值。大部分情况下$\vec{x}_P$不在网格点上，因此我们不可能知道其精确值，因此我们可以通过对周边网格点进行插值来推算$q^n$的值。一般就用双线性(或者在三维空间中三线性)插值，当然也有人提出用更加精确的插值方法。
\par
总而言之，让我们把所有的公式放在一起得到了半拉格朗日公式：
\begin{equation}
q^{n+1}_G=interpolate(q^n,\vec{x}_G-\Delta{t}\vec{u}_G)
\end{equation}
\par
注意到这里我们讨论的这个过去时刻的"粒子微团"完全是虚拟的。计算机里面可不会真的生成任何粒子:我们只是用拉格朗日的观点去更新欧拉对流方程而已。因为我们是用拉格朗日的视角去更新欧拉方程，因此这个方法被称为半拉格朗日方法。
\par
为了完整性起见，让我们在一维里面重新在演示一遍，简简单单就用前向欧拉方法和线性插值解这个半拉格朗日公式。对于格子$x_i$,我们可以回溯粒子的位置本来在$x_P=x_i-\Delta{t}u_i$这个地方，假设这个格子前后两个格子分别为$[x_j,x_{j+1}]$，并且设置$\alpha=(x_P-x_j)/\Delta{x}$为$x_i$的在区间$[x_j,x_(j+1)]$中的比例，那么我们很容易可以得到$q^n_P=(1-\alpha)q^n_j+\alpha{q^n_{j+1}}$，因此最终我们会这样做更新：
\begin{equation}
q_i^{n+1}=(1-\alpha)q^n_j+\alpha q^n_{j+1}
\end{equation}
\par
在实际模拟中，我们通常需要对流的速度场，有时候也会对流密度场(比如烟雾模拟)或者温度场。通常这些变量都存储在网格的中心点，但是速度信息则如前述那样，被存储在交错网格的边界处。在这些情况下，我们都要用合适的平均速度做对流，从而估计粒子的运动轨迹。
\subsection{边界条件}
如果那个"虚拟"的微团在流体内部，那么用上面的插值方法是没什么问题的。但是如果那个微团不在流体内部，那又会怎么样呢？会发生这种情况基本有两种可能性，一是流体真的是从外界流进来的，也就是说，这个流体微团是“新”的。第二种可能性是，这是由于数值模拟的误差造成的(微团真正的轨迹实际上处于流体内部，但是前向欧拉方法或者龙科库塔方法引入了数值误差，把这个微团放到流体之外了)。
\par
这就是边界条件问题。在第一种情况下，既然有从外界流入的流体，我们应该知道其流入的量，那样才能正确的解决问题。例如，如果流体是通过一个阀门流入的，速度为$\vec{U}$，那么任何从外界从这个边界进入流体的粒子，其速度都必须为$\vec{U}$。
\par
在第二种情况下，由于这是由于数值模拟的误差引起的，合适的策略是从流体边界点进行外插值。有时候这么做还挺容易的：如果边界点有速度的话，我们可以直接用。例如，如果要模拟的是空间中的烟雾，我们可以简单假设其具在流体外部有速度$\vec{U}$(或者为零)。
\par
更为复杂的情况是这个量本来不知道，需要从流体里面外插出来。我们将在第六章针对水详细描述这种情况。目前来说，我们只是关注在找到流体边界上离这个点最近点的情况，然后用插值的方法从流体网格中得出这个值。尤其是如果我们是要找从流体内部出发的速度值的情况。
\par
注意下，固液边界的流体速度跟整体的固体速度不是一码事。就像在之前讨论过的那样，流体速度的法向量值最好跟固体的速度值一致，但是除了粘性流动以外，切向值则可以毫无关系。这样我们可以插值出流体在边界处的速度，而不是简单的取固体的速度。然而，对于粘性流动的情况(或者，至少是流体与固体粘性很强的情况)，我们则需要直接把固液边界的流体速度设置成固体的速度。
\subsection{时间步长}
做过数值模拟都知道，任何数值方法都有一个稳定性的问题：会不会爆炸？很开心的一点是半拉格朗日算法是“无条件稳定”的：不管$\Delta{t}$有多大，模拟永远不会爆炸。原因也很简单：不管粒子的起始位置在哪里，我们都是从旧的$q$值算出新的$q$值。线性/双线性/三线性插值永远只能得出介于起始值和终止值之间的值，我们不可能得到比前一个时间步中更大或者更小的$q$值。因此，$q$始终是有界的。这真的是非常有吸引力的一件事情：我们可以在模拟的精确度和速度之间权衡，随意选择时间步长。比如，如果我们希望得到实时的结果而不管模拟的精度，我们可以使得$\Delta{t}$跟渲染的帧速度一样。
\par
在实践过程中，情况稍微有点变化，如果时间步长选的太过激进，太大，有可能会产生一些奇怪的结果。因此有文章建议，应该控制一下$\Delta{t}$，使得粒子最远也只能跑五个格子的宽度:
\begin{equation}
\Delta{t}\le{\frac{5\Delta{x}}{u_{max}}}  \label{timestamp}
\end{equation}
其中$u_{max}$是预估的流体最大速度。我们可以简简单单记录格子上所有速度值取最大来得到这个估计值，一个更为稳健的方法则在前面这个方法的基础上，加上重力加速度g或者其他体力比如浮力的影响，在这种情况下：
\begin{equation}
u_{max}=max(|u^n|)+\Delta{t}|g|   \label{umax}
\end{equation}
将式(\ref{umax})带入(\ref{timestamp})，在进行整理可以得到:
\begin{equation}
u_{max}=max(|u^n|)+\sqrt{5\Delta{x} g}   \label{umax_5times}
\end{equation}
这个方法的好处在于，结果始终是正的，因此式(\ref{timestamp})就不可能出现除以零的问题。
\subsubsection{CFL条件}
离开讨论对流的时间步长之前，我忍不住想要澄清一下一个我经常被人抱怨的问题。"CFL"条件可以说是在基于物理模拟里面最最常被误用和误解的术语。因此，这里我打算详细的解释一下。如果你对数值模拟的分析没什么兴趣，那么这部分可以完全跳过。
\par
CFL条件，是由三位应用数学家R.Courant, K.Fredrichs和H.Lewy共同命名的。它是一个很简单而且很直观的数值模拟收敛的必要条件。这里面收敛的意思是，如果你用越来越小，极限为零的$\delta{t}$和$\delta{x}$去做模拟，那么数值解将无限趋向于精确解。
\par
与时间相关的偏微分方程，例如对流方程，在某个特定空间点$\vec{x}^\star$z在某个特定的时间$t^\star$取决于一些或者全部的初始条件。也就是说有可能，有些初始条件即使改变了，也不会改变在$\vec{x}^\star$处，$t^\star$时刻这个解的值。然而，如果你改变了其他初始条件，这个值会发生变化。在一个常速度对流方程中，$q(\vec{x}^\star,t^\star)$就是$q(\vec{x}^\star-t^\star \vec{u},0)$，因此这个值仅取决于初始条件中的一个点的值。对其他微分方程，比如热传导方程$\partial{q}/\partial{t}=\nabla\cdot\nabla{q}$，每个点在任意时刻的解都取决于初始条件。基于上述讨论，我们可以定义某一个点的“依赖域”为对这个点有影响的那些点的集合。
\par
上面的讨论是针对真实情况的，每个点都有一个依赖域。对数值求解也一样，在数值求解不断迭代的过程中，每个点也有个依赖域：也就是那些对某点数值解有影响的初始条件点。显然，在$\delta{t}$和$\delta{x}$无限趋近于零的情况下，如果要得到正确的解，“数值依赖域”必须包含“真实依赖域”。这就是CFL条件：收敛只可能在如下条件满足的情况下才有可能，即如果$\Delta{x}\to{0}$且$\Delta{t}\to{0}$，则数值解的依赖域包含真实解的依赖域。
\par
对于半拉格朗日方法，CFL条件是自动满足的：在极限情况下，粒子的轨迹将无限接近于其真实轨迹，因此我们可以从正确的网格中插值得到正确的依赖域。因此，在半拉格朗日的情况下去讨论CFL条件实际上没什么意义，因为根本不需要，已经自动满足了。
\par
也就是说，对于求解对流方程的标准的显式有限差分算法，网格点$q_i^{n+1}$是从相邻网格点的旧值计算出来的。也就是说，只有对那些离开了原来的点$C\Delta{x}$距离的点，CFL条件才是有意义的，其中，C是一个较小的整数。尤其是，真正的求解实在速度场$|\vec{u}|$中，因此，数值求解的信息是有传输性的，也就是说$C\Delta{x}/\Delta{t}$，必须至少跟速度一样快，这样我们就得到了：
\begin{equation}
\frac{C\Delta{x}}{\Delta{t}}\ge{|\vec{u}|}
\end{equation}
变形一下就得到了：
\begin{equation}
\Delta{t}\le{\frac{C\Delta{x}}{|\vec{u}|}}  \label{CFL_last}
\end{equation}

现在是最为让人困惑的地方，上面的式子，如果C足够小的话，常常跟能让数值求解稳定的最大步长差不多。(当然也常常会有例外：比如我们这一章节介绍的第一个方法不管时间步长多小都是不稳定的，也有可能我们能够设计出一个不管时间步长多大都稳定但是除非CFL条件满足，否则结果是错误的方法)。因为这两者常常一样，因此人们经常会误解以为CFL跟稳定性的要求是一回事情，但实际上两者毫无关系。甚至有人认为只要满足\ref{CFL_last}，不管用什么数值模拟方法，稳定性都能满足。这显然是错误的。这里你可以看出来我们之前讨论的不等式(\ref{umax_5times})，其值是CFL条件的五倍--因此不管怎样，都很不合理。
\par
因此，现在你知道了。不要瞎用CFL条件这个词语，你实际上说的是稳定条件或者精确度条件而不是CFL条件。
\subsection{耗散}
注意到，在半拉格朗日方法求解对流方程的时候，我们是取前一个时刻物理量的加权平均来做插值的。也就是说，在每一个对流步，我们做的是平均这个操作。而平均操作的趋势是把起伏很大的特征抹平，这个步骤被称为"耗散"。接下来的很大部分内容就主要介绍避免这种“耗散”的方法：有些情况下“耗散”是非常灾难性的。
\par
让我们试着用更加物理的方式去理解这个平滑的现象。我们将用一种更加聪明的技术，成为"变种微分方程"。一般来说我们看待求解微分方程中的数值误差就是我们的计算结果是真实结果叠加上一部分错误得到的。另一种我们这里的看待这个问题的方法，有时候被称为"反向误差分析"，则是我们认为我们求解过程没有问题，只是题目本身跟真实情况有所偏差。用这种在原问题上加偏差的方法去理解并分析这个误差，这种方法是非常非常有用的。
\par
为了简化我们的分析，我们在一维空间中求解一个对流方程，其中速度是一个常量u>0:
\begin{equation}
\frac{\partial{q}}{\partial{t}}+u\frac{\partial{q}}{\partial{x}}=0
\end{equation}
假设，$\Delta{t}<\Delta{x}/u$，也就是说粒子的轨迹在一个时间片内是不会超过格子的宽度的--当然我们可以把时间片拓展到更长，但是其实没什么本质变化。在这种情况下，最终到达格子i的粒子轨迹的起始点在范围$[x_{i-1},x_i]$中。在$q^n_{i-1}$和$q_i^n$中的点$x_i-\Delta{t}u$做插值，得到：
\begin{equation}
q_i^{n+1}=\frac{\Delta{t} u}{\Delta{x}}q^n_{i-1}+(1-\frac{\Delta{t}u}{\Delta{x}})q^n_i
\end{equation}
重新整理下，得到：
\begin{equation}
q_i^{n+1}=q_i^n-\Delta{t}u\frac{q^n_i-q^n_{i-1}}{\Delta{x}} \label{q_n+1}
\end{equation}
实际上，这正是一维空间中的前向欧拉方法。现在让我们用泰勒级数展开$q_{i-1}^n$:
\begin{equation}
q^n_{i-1}=q_i^n-\left (\frac{\partial{q}}{\partial{x}}\right)^n_i\Delta{x}+\left(\frac{\partial^2{q}}{\partial{x}^2}\right)^n_i\frac{\Delta{x}^2}{2}+O(\Delta{x}^3) \label{taylorseries}
\end{equation}
将式(\ref{taylorseries})带入(\ref{q_n+1}得到：
\begin{equation}
\begin{aligned}
q_i^{n+1}&=q_i^n-\Delta{t}u\frac{1}{\Delta{x}}\left(\left(\frac{\partial{q}}{\partial{x}}\right)^n_i\Delta{x}-\left(\frac{\partial^2{q}}{\partial{x}^2}\right)^n_i\frac{\Delta{x}^2}{2}+O(\Delta{x^3})\right) \\
&=q_i^n-\Delta{t}u\left(\frac{\partial{q}}{\partial{x}}\right)^n_i+\Delta{t}u\Delta{x}\left(\frac{\partial^2{q}}{\partial{x}^2}\right)^n_i+O(\Delta{x}^2) \\
\end{aligned}
\end{equation}
这样子精确到二阶误差的情况下，这就是前向欧拉法求解变形微分方程的公式:
\begin{equation}
\frac{\partial{q}}{\partial{t}}+u\frac{\partial{q}}{\partial{x}}=u\Delta{x}\frac{\partial^2{q}}{\partial{x}^2}
\end{equation}
这看起来很像对流方程加一个年度为$u\Delta{x}$的粘性项！也就是说，当我们用半拉格朗日方法去求解无粘度对流方程的时候，我们的结果看起来反而有点像模拟有粘度流体！这种现象叫做"数字发散"或者叫做"数字扩散"
\par
幸运的是，这种数字发散随着$\Delta{x}\to{0}$而趋于零，所以我们在极限情况下得到了正确的解。不幸的是，在计算机图形学中，我们不可能让$\Delta{x}$变成0:我们要在$\Delta{x}$尽量大的情况下得到更好的效果。
\par
这个情况有多严重呢？取决于我们要怎样模拟。如果我们模拟的是有粘流体，本来就有很多自然的耗散，那么稍微有点数值耗散也没什么大关系--更为重要的是，有点这种耗散可能能让效果更逼真。但是，更大可能是我们想模拟的是无粘流体，这种时候可能会是个很麻烦的事情，因为这种耗散会将很多有趣的现象比如涡流平滑掉。对速度，这种数字扩散已经很糟糕了，但是在第六章，我们将看到这个现象如果出现在别的物理量上会更加糟糕。
\par
因此我们需要引入新的技术去修复这个问题。用更加精确的插值方法是一个部分解决问题的方法，但是这个方法代价很高而且经常还不够精确。我们后面的章节会介绍一些更加有效的办法。
\section{使流体不可压缩}
这一章我们研究下怎么使得流体不可压缩并且模拟施加边界条件，也就是我们在第二章里面提到过的，如果实现算法$project(\Delta t,\vec{u})$。首先我们会讲述一下怎么用经典方法去解决这个问题，之后我们会讨论怎么用更精确的离散化方法去解决这个问题。
\par

$project$这个方法会从中间速度场$\vec{u}$中减去压力梯度:
\begin{equation}
\vec{u}^{n+1}=\vec{u}-\Delta{t}\frac{1}{\rho}\nabla{p}
\end{equation}
这样，得到的结果就能够满足流体内部不可压缩这个条件了：
\begin{equation}
\nabla\cdot{\vec{u}^{n+1}}=0
\end{equation}
同时，还能满足固体边界条件:
\begin{equation}
\vec{u}^{n+1}\cdot{\hat{n}}=\vec{u}_{solid}\cdot{\hat{n}}
\end{equation}
这样，我们要做的第一件事情是将这个压力更新离散化：也就是说，我们要解决在MAC网格上，我们怎么估算压力梯度这个问题。然后我们将研究怎么在MAC网格上定义离散化散度。将两者结合起来，我们就能得到一系列线性方程组，求解之，可以得到压力值。我们这里将详细描述一下这个系统和求解这个系统的高效算法。我们将首先研究怎么将传统的MAC网格应用到矩形边界之上，因为处理倾斜和弯曲的边界实际上并不容易。在本章结束的时候，我们会重新解释压力方程，那样子我们就能得到一个简单但是精确、稳定的处理不规则边界条件的方法。
\subsection{离散压力梯度}
就像我们之前简单讨论过的一样，MAC网格的存在原因，是其通过交错的方式，让中心差分变得更为鲁棒。比如，在我们想要从速度u的x分量减掉压力的梯度$\partial/\partial{x}$的地方，有两个在速度u的两个分量两边排列的很完美的压力值等着被差分。可以参考图(\ref{fig:mac_grid_2d})研究下这是怎么工作的。
\par
不多bb，这里是2维情况下压力更新的公式，利用中心差分的形式去估算$\partial{p}/\partial{x}$和$\partial{p}/\partial{y}$:
\begin{equation}
\begin{aligned}
u_{i+1/2,j}^{n+1}&=u_{i+1/2,j}-\Delta{t}\frac{1}{\rho}\frac{p_{i+1,j}-p_{i,j}}{\Delta{x}} \\
v_{i,j+1/2}^{n+1}&=v_{i,j+1/2}-\Delta{t}\frac{1}{\rho}\frac{p_{i,j+1}-p_{i,j}}{\Delta{x}} \\
\end{aligned}
\end{equation}

在三维情况下，显然加上$\partial{p}/\partial{z}$就行了：
\begin{equation}
\begin{aligned}
u_{i+1/2,j,k}^{n+1}&=u_{i+1/2,j,k}-\Delta{t}\frac{1}{\rho}\frac{p_{i+1,j,k}-p_{i,j,k}}{\Delta{x}} \\
v_{i,j+1/2,k}^{n+1}&=v_{i,j+1/2,k}-\Delta{t}\frac{1}{\rho}\frac{p_{i,j+1,k}-p_{i,j,k}}{\Delta{x}} \\
w_{i,j,k+1/2}^{n+1}&=w_{i,j,k+1/2}-\Delta{t}\frac{1}{\rho}\frac{p_{i,j,k+1}-p_{i,j,k}}{\Delta{x}} \\
\end{aligned}
\end{equation}
注意到，这些压力更新要运用到任何内部含有流体的网格点的速度上面去。
\par
在之后的章节中，我们会研究如何计算内部含有流体的网格点的压力值。然而，上面的公式，及运用到了流体区域的边界，也运用到了流体的外部区域。所以我们需要指定我们的压力边界条件。我们将假定每个格子被分为流体格子(内部含有流体的各自)，固体格子(内部完全被固体占领的各自)，和空气格子(水面模拟的时候，内部啥都没有的格子)。本章最后，我们才会去处理一半空(或者一半是固体)一半有水的格子：目前，我们假设固体跟格子是完美对齐的，并且忽略那些自由表面上的半水半空格子，直接把这些格子标记成流体格子。
\par
边界压力条件中比较容易处理的是自由边界(也就是流体随便流动的时候的表面部分)，比如水表面模拟。在这种情况下，我们可以简单假定流体之外的压力统统为零: 具体到公式中，我们可以简简单单将空气格子的$p_{i,j,k}$都设定为零。如果你对数学术语感兴趣的话，这种做法被称为"狄利克雷"边界条件。"狄利克雷"是一个数学家，这个术语的数学含义就是我们是直接指定边界上物理量的值的。
\par
边界压力条件中比较难的问题是怎么处理墙壁等固体。因为之前做过假定，固体墙壁是跟格子平行的，我们可以知道固体格子的速度各分量为：$\vec{u}^{n+1}\cdot{\hat{n}}=\vec{u}_{solid}\cdot\hat{n}$。这个其实就是压力的法向导数(数学上，这种边界条件被称为"诺伊曼"边界条件)。用这个公式代入压力更新公式，会得到一个组简单的线性方程组，其解为墙壁内部的压力值。例如，假设格子$(i,j)$是流体各自并且格子$(i+1,j)$是固体各自，那么我们可以这样更新$u_{i+1/2,j}$:
\begin{equation}
u^{n+1}_{i+1/2,j}=u_{i+1/2,j}-\Delta{t}\frac{1}{\rho}\frac{p_{i+1,j}-p_{i,j}}{\Delta{x}}
\end{equation}
我们知道，上式里面$u^{n+1}_{i+1/2,j}$实际上就是$u_{solid}$，重新整理下，得到：
\begin{equation}
p_{i+1,j}=p_{i,j}+\frac{\rho\Delta{x}}{\Delta{t}}(u_{i+1/2,j}-u_{solid})  \label{solid_boundry_condition}
\end{equation}
嗯，看到那里，很多同学应该开始挠头，难道不是直接将$u^{n+1}_{i+1/2,j}$设成想要的值会比较简单吗？为什么要计算压力的差值呢？实际上，确实有很多流体模拟器是这样做的，先直接设置墙壁的速度，然后再去考虑计算压力值。但是，在本章的最后，我们将会看到，如果先计算压力差值，在流体连续的情况下，结果更未正确。而且，说白了我们也迟早需要计算流体内部压力的公式。
\par
另一件需要特别注意很奇怪的事情是关于边界条件的。我们需要单独计算固体格子每个边界面的压力。也就是说，如果这个固体格子有两个或者多个面跟液体格子接触，那么我们需要分别单独计算这个格子的压力值。听上去这挺奇怪的，请记住从根子上来说，从连续体的角度来说，压力并不是在固体内部定义的：我们在格子边界用压力梯度做运算。数值上说，将之表达为有限差分更为方便(如果满足所有其他方程的话)，但是实际上当我们讨论固体格子内部的压力的时候，我们只是做了些方便的数学想象。真正起作用的是边界上的压力差。所以我们实际上不会显式的存储固体格子内部的压力(因为可能有多个值)，当我们需要知道边界的压力差的时候，我们会利用式(\ref{solid_boundry_condition})去计算。
\par
边界条件真的是蛮复杂的--实际上在计算流体力学届，流传着这样一个传说：90%人的汗水、眼泪和鲜血都花费在如何将边界条件计算正确上面了。因此，画个精细的MAC网格，仔细观察不同类型的格子(固体格子，液体格子和空气格子)，然后把这一章慢慢再看一遍确保你确实明白了掌握了，还是很有必要的。
\subsection{离散散度}
现在来看看本章相对比较简单的部分!在连续体的例子里，我们希望我们的流体不可压缩，也就是$\nabla\cdot\vec{u}=0$。在格子上，我们用有限差分去模拟这个条件，去确保对每个流体格子,${\vec{u}_{n+1}}$散度为零。二维情况下，散度的表达式为：
\begin{equation}
\nabla\cdot{\vec{u}}=\frac{\partial{u}}{\partial{x}}+\frac{\partial{v}}{\partial{y}}
\end{equation}
三维情况下，则是：
\begin{equation}
\nabla\cdot{\vec{u}}=\frac{\partial{u}}{\partial{x}}+\frac{\partial{v}}{\partial{y}}+\frac{\partial{w}}{\partial{z}}
\end{equation}
利用中间差分方法(重新看下MAC网格吧),我们可以这样估计二维情况下，流体格子(i,j)的散度:
\begin{equation}
(\nabla\cdot{\vec{u}})_{i,j}\approx{\frac{u_{i+1/2,j}-u_{i-1/2,j}}{\Delta{x}}+\frac{v_{i,j+1/2}-v_{i,j-1/2}}{\Delta{x}}}
\end{equation}
三维情况下，显然是：
\begin{equation}
(\nabla\cdot{\vec{u}})_{i,j,k}\approx{\frac{u_{i+1/2,j,k}-u_{i-1/2,j,k}}{\Delta{x}}+\frac{v_{i,j+1/2,k}-v_{i,j-1/2,k}}{\Delta{x}}+\frac{v_{i,j,k+1/2}-v_{i,j,k-1/2}}{\Delta{x}}}
\end{equation}
注意下，我们只会去计算标记为流体格子的散度。
\par
另一个表示我们这里定义的离散散度的方法是通过直接估计进入和流出这个格子流体的量来计算。这其实就是(如果是连续流体的话)速度的法向量在格子各个面上的积分值：
\begin{equation}
\int{\int_{\partial{cell}}}\vec{u}\cdot\hat{n}
\end{equation}
注意上面的积分是需要计算格子所有表面的。由于我们已经在所有面上都记录了速度在法向的分量了，我们可以简简单单通过这个法向速度乘以面积(但是需要注意一下符号，法向量都是指向格子外的，而速度则都是指向一个方向的，可以继续参考下MAC网格那个图)。在做了缩放以后，其实我们能得到同样的中间差分公式。如果你感兴趣，这个步骤可以自己推导一下。这个数值技巧，也就是说我们直接通过估计每个面上值的积分而不是用差分方程来估计散度的方法，被称为“有限体积”法。
\par
最后，我们还要注意一下，为什么MAC网格是特别有用的。如果我们用一个传统的"同构"网格，也就是那种把所有物理量包括速度全都记录在网格点上的方法，那么我们处理散度就会非常的麻烦。比如，如果用中心点差分公式：
\begin{equation}
(\nabla\cdot\vec{u}\approx \frac{u_{i+1,j}-u_{i-1,j}}{2\Delta{x}} + \frac{v_{i,j+1}-v_{i,j-1}}{2\Delta{x}})
\end{equation}
用这种方法的话，我们将有可能重新碰到第二章讲过的零值空间问题。有些高散度速度场例如$\vec{u}_{i,j}=((-1)^i,(-1)^j)$会得到零散度。因此压力解不能更新这个速度场，结果就是高频振荡会永远持续下去，再加上对流部分的话，甚至可能会更加不稳定，速度不断增大以至于发散。如果由于种种原因，坚持用“同构”网格的话，有两种解决这个问题的方法。第一种是用一个有“偏见”的网格，也就是说只用一个边去计算差分--用这种方法，虽然能稳定速度场，但是实际上结果很明显看起来就不对。第二种方法是在求解压力项之前，将高频部分做平滑。为了解决这个问题--不幸的是，我们的主要目的避免数值误差，但是这种方法反而加入了平滑的误差，因此这也不是个好办法。说那么多废话，结果还是那句话，就用MAC网格就完了。

\end{document}
